<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="utf-8" />
    <title>Socket.IO Test Client</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {
            font-family: ui-sans-serif, system-ui, sans-serif;
            margin: 24px;
        }

        fieldset {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 16px;
        }

        legend {
            padding: 0 8px;
            color: #444;
        }

        label {
            display: block;
            font-size: 14px;
            margin: 6px 0 4px;
        }

        input[type="text"],
        input[type="url"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }

        button {
            padding: 8px 12px;
            border-radius: 8px;
            border: 0;
            background: #111827;
            color: #fff;
            cursor: pointer;
        }

        button.secondary {
            background: #6b7280;
        }

        button:disabled {
            opacity: .6;
            cursor: not-allowed;
        }

        #status {
            margin: 8px 0 0;
            font-size: 13px;
            color: #374151;
        }

        #log {
            list-style: none;
            padding: 0;
        }

        #log li {
            padding: 6px 8px;
            border-bottom: 1px dashed #e5e7eb;
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            font-size: 13px;
            white-space: pre-wrap;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 8px;
        }

        .two {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .muted {
            color: #6b7280;
        }
    </style>
</head>

<body>
    <h2>Socket.IO Test Client</h2>

    <fieldset>
        <legend>Kết nối</legend>
        <label>Server URL</label>
        <input id="serverUrl" type="url" placeholder="vd: http://localhost:4000" />
        <label>JWT (điền nếu server yêu cầu xác thực ở handshake)</label>
        <input id="token" type="text" placeholder="dán JWT vào đây" />
        <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
            <button id="btnConnect">Kết nối</button>
            <button id="btnDisconnect" class="secondary" disabled>Ngắt</button>
            <span id="status" class="muted">Chưa kết nối</span>
        </div>
    </fieldset>

    <fieldset>
        <legend>Gửi tin nhắn</legend>
        <div class="two">
            <div>
                <label>To User ID (tuỳ chọn)</label>
                <input id="toUserId" type="text" placeholder="Để trống = broadcast (message-send)" />
            </div>
            <div>
                <label>Nội dung</label>
                <input id="text" type="text" placeholder="Nhập nội dung tin nhắn" />
            </div>
        </div>
        <div style="margin-top:8px; display:flex; gap:8px;">
            <button id="btnSend">Send</button>
            <button id="btnPing" class="secondary">Log trạng thái</button>
        </div>
    </fieldset>

    <fieldset>
        <legend>Log</legend>
        <ul id="log"></ul>
    </fieldset>

    <!-- Socket.IO client script (được phục vụ bởi server ở /socket.io/socket.io.js) -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // === Helpers ===
        const $ = (id) => document.getElementById(id);
        const $log = $("log");
        const log = (m) => { const li = document.createElement('li'); li.textContent = m; $log.prepend(li); };
        const setStatus = (t) => { $("status").textContent = t; };

        // === State ===
        let socket = null;

        // === Connect / Disconnect ===
        $("btnConnect").addEventListener("click", (e) => {
            e.preventDefault();
            const url = $("serverUrl").value.trim() || window.location.origin;
            const token = $("token").value.trim();

            if (socket && socket.connected) {
                log('Đã kết nối rồi: ' + socket.id);
                return;
            }

            try {
                socket = io(url, {
                    transports: ['websocket', 'polling'],
                    withCredentials: true,
                    // Server chấp nhận token tại handshake qua auth.token hoặc header Authorization
                    auth: token ? { token } : undefined,
                    extraHeaders: token ? { Authorization: 'Bearer ' + token } : undefined,
                });

                bindCoreEvents(socket);
                bindMessageEvents(socket);

                $("btnDisconnect").disabled = false;
            } catch (err) {
                log('Lỗi khởi tạo socket: ' + (err?.message || err));
            }
        });

        $("btnDisconnect").addEventListener("click", (e) => {
            e.preventDefault();
            if (socket) {
                socket.disconnect();
            }
        });

        function bindCoreEvents(s) {
            s.on('connect', () => {
                log('CONNECTED: ' + s.id);
                setStatus('Đã kết nối: ' + s.id);
            });
            s.on('connect_error', (e) => {
                log('CONNECT_ERROR: ' + (e?.message || e));
                setStatus('Lỗi kết nối');
            });
            s.on('disconnect', (reason) => {
                log('DISCONNECTED: ' + reason);
                setStatus('Đã ngắt kết nối');
                $("btnDisconnect").disabled = true;
            });
            // Nếu server trả error từ middleware (vd: auth fail)
            s.on('error', (e) => log('ERROR: ' + JSON.stringify(e)));
        }

        function bindMessageEvents(s) {
            // Phù hợp với broadcast server: this.io?.emit('message-new', message)
            s.on('message-new', (msg) => log('[BROADCAST message-new] ' + JSON.stringify(msg)));
            // Phù hợp với direct: io.to(targetSocketId).emit('message-new-direct', message)
            s.on('message-new-direct', (msg) => log('[DIRECT message-new-direct] ' + JSON.stringify(msg)));
        }

        // === Send ===
        $("btnSend").addEventListener("click", (e) => {
            e.preventDefault();
            if (!socket || !socket.connected) { log('Chưa kết nối'); return; }
            const toUserId = $("toUserId").value.trim();
            const text = $("text").value.trim();
            if (!text) { log('Text trống'); return; }

            if (toUserId) {
                // phù hợp với server event: 'message-on-toUser'
                socket.emit('message-on-toUser', { toUserId, text }, (ack) => {
                    log('[ACK message-on-toUser] ' + JSON.stringify(ack));
                });
            } else {
                // phù hợp với server event: 'message-send'
                socket.emit('message-send', { text }, (ack) => {
                    log('[ACK message-send] ' + JSON.stringify(ack));
                });
            }
            $("text").value = '';
        });

        $("btnPing").addEventListener("click", (e) => {
            e.preventDefault();
            if (!socket) { log('Socket chưa khởi tạo'); return; }
            log('connected=' + !!socket.connected + ', id=' + socket.id);
        });
    </script>
</body>

</html>